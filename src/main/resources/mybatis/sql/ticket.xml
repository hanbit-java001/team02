<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ticket">
	<insert id="insertShares" parameterType="map">
		INSERT INTO SHARES
			(group_yn, owner_yn, reserved_number, share_id)
		VALUES
			(#{groupYn}, #{ownerYn}, #{reservedNumber}, #{shareId})
	</insert>

	<insert id="reserveTicket" parameterType="TicketVO">
		INSERT INTO TICKET
			(train_id, seat_number, reserved_number, name, reserved_time, cancel)
		VALUES
			(#{trainId}, #{seatNumber}, #{reservedNumber}, #{name}, #{reservedTime}, #{cancel})
	</insert>

	<select id="selectTickets" parameterType="map" resultType="TicketVO">
		SELECT t.train_id, t.seat_number, t.reserved_number, t.name, t.reserved_time, t.cancel
		  FROM TICKET t, SHARES s
	     WHERE t.cancel = #{cancel}
	       AND ((s.group_yn = 'N' AND s.share_id = {#memberId})
		    OR (s.group_yn = 'Y' AND s.share_id IN (
				SELECT group_id
				  FROM GROUP_MEMBER
				 WHERE member_id = {#memberId}))
	 	       )
	  ORDER BY reserved_number
	</select>

	<select id="selectTicket" parameterType="map" resultType="TicketVO">
		SELECT t.train_id, t.seat_number, t.reserved_number, t.name, t.reserved_time, t.cancel
		  FROM TICKET t, SHARES s
		 WHERE t.reserved_number = #{reservedNumber} AND t.cancel = #{cancel}
		   AND ((s.group_yn = 'N' AND s.share_id = {#memberId})
		    OR (s.group_yn = 'Y' AND s.share_id IN (
				SELECT group_id
				  FROM GROUP_MEMBER
				 WHERE member_id = #{memberId}))
		       )
	</select>

	<update id="cancelTicket" parameterType="TicketVO">
		UPDATE TICKET
		   SET cancel = #{cancel}
		 WHERE reserved_number IN (
		 		SELECT t.reserved_number
		 		  FROM TICKET t, SHARES s
		 		 WHERE t.reserved_number = #{reservedNumber}
		 		   AND t.reserved_number = s.reserved_number
		 		   AND s.group_yn = 'N'
		 		   AND s.owner_yn = 'Y'
		 		   AND s.share_id = #{memberId}
		 )
	</update>
</mapper>
